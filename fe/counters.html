
<head>
<title>Test</title>
</head>
<body>
<h3>Showing graphs for key: <span id="key"></span></h3>
<div id="placeholder" style="width:1200px;height:300px">
</div>
<select id="props">
</select>
<button name="refresh">Refresh keys</button>
<button name="stop">Stop</button>
<script type="text/javascript" src="http://o.aolcdn.com/os/aol/jquery-1.5.2.min.js"></script>
<script type="text/javascript" src="./flot/jquery.flot.js"></script>
<script type="text/javascript">
var loopTimer;
var UTC_OFFSET = new Date().getTimezoneOffset() * 60 * 1000 ;

function getData(key) {
    var now = new Date().getTime() - UTC_OFFSET;
    var data = [];
    $.ajax({
        url: "http://localhost:20000/stats",
        /*data: {'ts': now, "host": ["host1", "host2", "host3"], "key": key || "a.b", "dur": (6 * 60 * 60)}, */
        data: {'ts': now, "host": ["ag.office.aol.com"], "key": key || "a.b", "dur": (6 * 60 * 60)},
        traditional: true,
        async: false, 
        dataType: 'jsonp',
        jsonpCallback: 'data'
    });
}

function data(d) {
    var p = [], data = [];
    for (h in d) {
    console.log(h);
        var dd = d[h];
//        console.log(dd);
        for (var i = 0; i < dd.length; i++) {
            p.push([new Date(Number(dd[i].ts)), dd[i].val]);
        }
        data.push({"label": h, "data": p});
        p = [];
    }
    //console.log(data);
    $.plot($('#placeholder'), data, { 
        series: { 
            points: {show: true}, 
            lines: {show: true}
        }, 
        xaxis: {
            'mode':'time',
            'twelveHourClock': true
        }
    });
}


function init(key) {
    $('#key').html(key || "a.b");
    if (loopTimer) clearInterval(loopTimer);
    getData(key);
    loopTimer = setInterval(function() {
        getData(key)
    }, 10000);
}

$('button[name=stop]').click(function(e) {
    e.preventDefault();
    if (loopTimer) clearInterval(loopTimer);
});

$('button[name=refresh]').click(function(e) {
    e.preventDefault();
    refreshKeys();
});

$('#props').change(function(e) {
    e.preventDefault();
    init($(e.target).find(':selected:').val());
});

function refreshKeys() {
    $.ajax({
        url: "http://localhost:20000/keys",
        data: {"type": "c"},
        dataType: 'jsonp',
        jsonpCallback: 'keys'
    });
}

function keys(d) {
    var s = "";
    for (var i = 0; i < d.length; i++) {
        s += "<option val='" + d[i] + "'>" + d[i] + "</option>";
    }
    $('#props').html(s);
}

refreshKeys();
init("cache.hit");
</script>
</body>
</html>
